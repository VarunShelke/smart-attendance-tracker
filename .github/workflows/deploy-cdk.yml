name: Deploy CDK Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - 'backend/src/lambda/**'
      - 'frontend/**'
      - '.github/workflows/deploy-cdk.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
        default: 'production'

# Prevent concurrent deployments to the same environment
concurrency:
  group: cdk-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.13'

# Explicitly set minimal permissions at the top level
permissions:
  id-token: write   # Required for OIDC authentication
  contents: read    # Required to checkout code
  pull-requests: write  # Required for PR comments (if needed)

jobs:
  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      has-changes: ${{ steps.diff.outputs.has-changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for proper diffing

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/src/lambda/requirements.txt

      - name: Install infrastructure dependencies
        working-directory: infrastructure
        run: |
          npm ci --prefer-offline --no-audit
          npm run build

      - name: Install Lambda dependencies
        working-directory: backend/src/lambda
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: Run CDK synth
        working-directory: infrastructure
        run: |
          npx cdk synth --strict --version-reporting=false

      - name: Check for infrastructure changes
        id: diff
        run: |
          if git diff --quiet HEAD~1 HEAD -- infrastructure/ backend/src/lambda/ .github/workflows/deploy-cdk.yml; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Run npm audit
        working-directory: infrastructure
        run: |
          npm audit --audit-level=moderate || true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [ validate, security-scan ]
    if: needs.validate.outputs.has-changes == 'true' || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.amplify-url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Debug Role ARN
        run: |
          echo "Role ARN length: ${#AWS_DEPLOY_ROLE_ARN}"
          echo "Role ARN (first 30 chars): ${AWS_DEPLOY_ROLE_ARN:0:30}"
          echo "Role ARN (last 30 chars): ${AWS_DEPLOY_ROLE_ARN: -30}"
        env:
          AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: GitHubActions-CDK-Deploy-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          # Security best practices
          role-duration-seconds: 3600
          mask-aws-account-id: true

      - name: Verify AWS credentials
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "AWS credentials verified successfully"

      - name: Install infrastructure dependencies
        working-directory: infrastructure
        run: |
          npm ci --prefer-offline --no-audit

      - name: Install Lambda dependencies
        working-directory: backend/src/lambda
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build CDK project
        working-directory: infrastructure
        run: |
          npm run build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - name: CDK diff
        id: diff
        working-directory: infrastructure
        run: |
          npx cdk diff --strict 2>&1 | tee cdk-diff.txt || true
        continue-on-error: true

      - name: Upload diff artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cdk-diff
          path: infrastructure/cdk-diff.txt
          retention-days: 30

      - name: CDK deploy
        id: deploy
        working-directory: infrastructure
        run: |
          echo "Starting CDK deployment..."

          # Deploy with verbose output
          npx cdk deploy \
            --require-approval never \
            --verbose \
            --progress events \
            --outputs-file cdk-outputs.json \
            --ci true

          echo "CDK deployment completed successfully"

          # Extract Amplify URL if available
          if [ -f cdk-outputs.json ]; then
            AMPLIFY_DOMAIN=$(jq -r '.SmartAttendanceTrackerStack.AmplifyAppDefaultDomain // empty' cdk-outputs.json)
            if [ -n "$AMPLIFY_DOMAIN" ]; then
              echo "amplify-url=https://$AMPLIFY_DOMAIN" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cdk-outputs
          path: infrastructure/cdk-outputs.json
          retention-days: 90

      - name: Verify deployment
        working-directory: infrastructure
        run: |
          echo "Verifying deployed resources..."

          # Get stack status
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name SmartAttendanceTrackerStack \
            --query 'Stacks[0].StackStatus' \
            --output text \
            --region ${{ env.AWS_REGION }})

          echo "Stack status: $STACK_STATUS"

          if [[ "$STACK_STATUS" != "CREATE_COMPLETE" && "$STACK_STATUS" != "UPDATE_COMPLETE" ]]; then
            echo "Error: Stack deployment failed with status: $STACK_STATUS"
            exit 1
          fi

          echo "Deployment verification completed successfully"

      - name: Post-deployment validation
        working-directory: infrastructure
        run: |
          echo "Running post-deployment validation..."

          # Validate CloudFormation outputs
          if [ -f cdk-outputs.json ]; then
            echo "Validating CDK outputs..."

            # Check for required outputs
            REQUIRED_OUTPUTS=("UserPoolId" "UserPoolClientId" "AmplifyAppId" "StudentImagesBucketName")

            for output in "${REQUIRED_OUTPUTS[@]}"; do
              VALUE=$(jq -r ".SmartAttendanceTrackerStack.$output // empty" cdk-outputs.json)
              if [ -z "$VALUE" ]; then
                echo "Warning: Required output $output is missing"
              else
                echo "✓ $output: $VALUE"
              fi
            done
          fi

      - name: Cleanup on failure
        if: failure()
        working-directory: infrastructure
        run: |
          echo "Deployment failed. Checking stack events for errors..."

          aws cloudformation describe-stack-events \
            --stack-name SmartAttendanceTrackerStack \
            --max-items 10 \
            --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED`].[LogicalResourceId,ResourceStatusReason]' \
            --output table \
            --region ${{ env.AWS_REGION }} || true

  deploy-frontend:
    name: Deploy Frontend to Amplify
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: deploy
    if: needs.deploy.result == 'success'
    environment:
      name: production
      url: ${{ steps.verify.outputs.amplify-url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Debug Role ARN
        run: |
          echo "Role ARN length: ${#AWS_DEPLOY_ROLE_ARN}"
          echo "Role ARN (first 30 chars): ${AWS_DEPLOY_ROLE_ARN:0:30}"
          echo "Role ARN (last 30 chars): ${AWS_DEPLOY_ROLE_ARN: -30}"
        env:
          AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: GitHubActions-Frontend-Deploy-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
          mask-aws-account-id: true

      - name: Download CDK outputs
        uses: actions/download-artifact@v4
        with:
          name: cdk-outputs
          path: infrastructure/

      - name: Extract environment variables from CDK outputs
        id: extract-env
        working-directory: infrastructure
        run: |
          echo "Extracting CDK outputs..."

          # Parse CDK outputs
          USER_POOL_ID=$(jq -r '.SmartAttendanceTrackerStack.UserPoolId' cdk-outputs.json)
          USER_POOL_CLIENT_ID=$(jq -r '.SmartAttendanceTrackerStack.UserPoolClientId' cdk-outputs.json)
          API_ENDPOINT=$(jq -r '.SmartAttendanceTrackerStack.ApiEndpoint' cdk-outputs.json)
          API_KEY_VALUE=$(jq -r '.SmartAttendanceTrackerStack.ApiKeyValue' cdk-outputs.json)
          AMPLIFY_APP_ID=$(jq -r '.SmartAttendanceTrackerStack.AmplifyAppId' cdk-outputs.json)
          AMPLIFY_DOMAIN=$(jq -r '.SmartAttendanceTrackerStack.AmplifyAppDefaultDomain' cdk-outputs.json)

          # Validate required outputs
          if [ -z "$USER_POOL_ID" ] || [ -z "$USER_POOL_CLIENT_ID" ] || [ -z "$API_ENDPOINT" ] || [ -z "$AMPLIFY_APP_ID" ]; then
            echo "Error: Required CDK outputs are missing"
            exit 1
          fi

          # Export as GitHub outputs (masked for security)
          echo "user-pool-id=$USER_POOL_ID" >> $GITHUB_OUTPUT
          echo "user-pool-client-id=$USER_POOL_CLIENT_ID" >> $GITHUB_OUTPUT
          echo "api-endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "::add-mask::$API_KEY_VALUE"
          echo "api-key=$API_KEY_VALUE" >> $GITHUB_OUTPUT
          echo "amplify-app-id=$AMPLIFY_APP_ID" >> $GITHUB_OUTPUT
          echo "amplify-domain=$AMPLIFY_DOMAIN" >> $GITHUB_OUTPUT

          echo "✓ Environment variables extracted successfully"

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm ci --prefer-offline --no-audit

      - name: Build frontend with environment variables
        working-directory: frontend
        run: |
          echo "Building frontend with production configuration..."

          # Build with environment variables
          VITE_AWS_REGION=${{ env.AWS_REGION }} \
          VITE_AWS_USER_POOL_ID=${{ steps.extract-env.outputs.user-pool-id }} \
          VITE_AWS_USER_POOL_CLIENT_ID=${{ steps.extract-env.outputs.user-pool-client-id }} \
          VITE_API_ENDPOINT=${{ steps.extract-env.outputs.api-endpoint }} \
          VITE_API_KEY=${{ steps.extract-env.outputs.api-key }} \
          npm run build

          # Verify build output
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "Error: Build output is invalid"
            exit 1
          fi

          echo "✓ Frontend build completed successfully"

      - name: Create deployment ZIP
        working-directory: frontend
        run: |
          cd dist
          zip -r ../frontend-build.zip .
          cd ..

          echo "Build size: $(du -h frontend-build.zip | cut -f1)"

      - name: Create Amplify deployment
        id: create-deployment
        run: |
          echo "Creating Amplify deployment..."

          DEPLOYMENT_OUTPUT=$(aws amplify create-deployment \
            --app-id "${{ steps.extract-env.outputs.amplify-app-id }}" \
            --branch-name "main" \
            --region ${{ env.AWS_REGION }} \
            --output json)

          JOB_ID=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.jobId')
          ZIP_UPLOAD_URL=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.zipUploadUrl')

          if [ -z "$JOB_ID" ] || [ -z "$ZIP_UPLOAD_URL" ]; then
            echo "Error: Failed to create deployment"
            exit 1
          fi

          echo "job-id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "zip-upload-url=$ZIP_UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "✓ Deployment created with Job ID: $JOB_ID"

      - name: Upload build to S3
        working-directory: frontend
        run: |
          echo "Uploading build artifacts..."

          curl -X PUT \
            -H "Content-Type: application/zip" \
            --data-binary @frontend-build.zip \
            "${{ steps.create-deployment.outputs.zip-upload-url }}"

          if [ $? -ne 0 ]; then
            echo "Error: Failed to upload build"
            exit 1
          fi

          echo "✓ Build uploaded successfully"

      - name: Start Amplify deployment
        run: |
          echo "Starting Amplify deployment..."

          aws amplify start-deployment \
            --app-id "${{ steps.extract-env.outputs.amplify-app-id }}" \
            --branch-name "main" \
            --job-id "${{ steps.create-deployment.outputs.job-id }}" \
            --region ${{ env.AWS_REGION }}

          echo "✓ Deployment started"

      - name: Monitor deployment status
        id: monitor
        run: |
          echo "Monitoring deployment progress..."

          MAX_ATTEMPTS=90  # 15 minutes with 10-second intervals
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            JOB_STATUS=$(aws amplify get-job \
              --app-id "${{ steps.extract-env.outputs.amplify-app-id }}" \
              --branch-name "main" \
              --job-id "${{ steps.create-deployment.outputs.job-id }}" \
              --region ${{ env.AWS_REGION }} \
              --query 'job.summary.status' \
              --output text)

            echo "Deployment status: $JOB_STATUS (attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS)"

            if [ "$JOB_STATUS" = "SUCCEED" ]; then
              echo "✓ Deployment completed successfully"
              exit 0
            elif [ "$JOB_STATUS" = "FAILED" ] || [ "$JOB_STATUS" = "CANCELLED" ]; then
              echo "Error: Deployment failed with status: $JOB_STATUS"

              # Get job details for debugging
              aws amplify get-job \
                --app-id "${{ steps.extract-env.outputs.amplify-app-id }}" \
                --branch-name "main" \
                --job-id "${{ steps.create-deployment.outputs.job-id }}" \
                --region ${{ env.AWS_REGION }} \
                --query 'job.steps[*].[stepName,status,statusReason]' \
                --output table

              exit 1
            fi

            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "Error: Deployment timed out after 15 minutes"
          exit 1

      - name: Verify deployment
        id: verify
        run: |
          AMPLIFY_URL="https://main.${{ steps.extract-env.outputs.amplify-domain }}"

          echo "Verifying deployment at: $AMPLIFY_URL"
          echo "amplify-url=$AMPLIFY_URL" >> $GITHUB_OUTPUT

          # Wait for DNS propagation
          sleep 30

          # Check HTTP status
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$AMPLIFY_URL" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✓ App is accessible (HTTP $HTTP_STATUS)"
          else
            echo "Warning: App returned HTTP status $HTTP_STATUS (may be transient)"
          fi

          # Output console link
          echo "Amplify Console: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}#/${{ steps.extract-env.outputs.amplify-app-id }}/main/${{ steps.create-deployment.outputs.job-id }}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-build
          path: frontend/frontend-build.zip
          retention-days: 30

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [ deploy, deploy-frontend ]
    if: always()

    steps:
      - name: Deployment Success
        if: needs.deploy.result == 'success' && needs.deploy-frontend.result == 'success'
        run: |
          echo "✅ Deployment completed successfully"
          echo "Backend: CDK stack deployed"
          echo "Frontend: Amplify app deployed"
          echo "Deployment triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

      - name: Deployment Failure
        if: needs.deploy.result == 'failure' || needs.deploy-frontend.result == 'failure'
        run: |
          echo "❌ Deployment failed"
          echo "Backend status: ${{ needs.deploy.result }}"
          echo "Frontend status: ${{ needs.deploy-frontend.result }}"
          echo "Deployment triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          exit 1

      - name: Deployment Skipped
        if: needs.deploy.result == 'skipped'
        run: |
          echo "⏭️ Deployment skipped (no changes detected)"